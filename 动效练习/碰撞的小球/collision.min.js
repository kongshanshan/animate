/*
鐢熸垚寮规€у皬鐞冪鎾炲伐鍏�
I am kmh0228
QQ:1150123276
2017-06-20
*/
/*
浣跨敤鏂规硶璇存槑
	1.姝ゆ彃浠剁函鍘熺敓js缂栧啓锛屼娇鐢ㄦ椂寮曞叆姝ollision.js鍗冲彲銆�
	2.鐢熸垚瀹瑰櫒锛屽亣璁剧幇鏈変竴涓猧d涓篶ontainer鐨勭洅瀛愬仛瀹瑰櫒銆�
		var oB=new BallBox(鈥榗ontainer鈥�);
			娉細瀹瑰櫒蹇呴』鏄湁瀹介珮鐨勫畾浣嶅厓绱犮€傚敖閲忎笉瑕佹湁杈圭嚎銆�
	3.鐢熸垚灏忕悆
		var ball=new Ball();
	4.鎶婂皬鐞冩斁鍏ュ鍣�
		oB.addBall(ball);
	5.璋冪敤瀹瑰櫒鐨刡allRun鏂规硶锛岃灏忕悆寮€濮嬭繍鍔ㄣ€傛敞鎰忥細姝よ繍鍔ㄦ槸瀹屽叏寮规€х鎾烇紝涓嶄細鎹熷け鑳介噺銆�
		oB.ballRun();
	over
	
	鍙傛暟璇存槑
		瀹瑰櫒鍙傛暟  new BallBox(鈥榗ontainer鈥欙紝opts);
			opts:{width:num,height:num}//娌℃湁杈圭嚎鍜宲adding鐨勬椂鍊欏彲涓嶅啓銆傛湁鐨勬儏鍐典笅闇€瑕佹妸瀹瑰櫒鐪熷疄瀹介珮濉繘鍘汇€�
		灏忕悆鍙傛暟 new Ball(opts);
			opts:{
				e:灏忕悆DOM鍏冪礌/鍘熺敓瀵硅薄锛屽彲濉叆椤甸潰DOM锛屼笉鍐欏垯鐢熸垚鏂癉IV DOM,
				b:灏忕悆鍗婂緞 榛樿30;鍖呭惈杈�
				c:灏忕悆鑳屾櫙棰滆壊/鍥剧墖锛� 榛樿'pink'
				borderWidth:杈圭嚎瀹藉害 榛樿0
				borderColor:杈圭嚎棰滆壊 榛樿#000
				x:灏忕悆涓績鐐圭殑妯潗鏍� 榛樿涓哄崐寰�
				y:灏忕悆涓績鐐圭殑绾靛潗鏍� 榛樿涓哄崐寰�
				sx:灏忕悆鍦▁杞存柟鍚戦€熷害姣�30ms锛岄粯璁�3
				sy:灏忕悆鍦▂杞存柟鍚戦€熷害姣�30ms锛岄粯璁�3
				m:灏忕悆鐨勮川閲忥紝榛樿b/30;
				html:灏忕悆鍐呴儴鐨勫唴瀹癸紝涓嶅～鍒欎笉浼氭敼鍙楧OM鏈韩鐨勫唴瀹广€�
				fontSize:瀛椾綋澶у皬锛岄粯璁�12;
				opa:灏忕悆閫忔槑搴︼紝榛樿1锛�
				callBack:function  纰版挒鏃剁殑鍥炴帀鍑芥暟锛屽弬鏁颁负纰版挒鐨勬€绘鏁帮紝鏂规硶涓璽his鎸囧悜姝ょ悆瀵硅薄
			}
		灏忕悆鏂规硶锛�
				setB(num)//閲嶆柊璁剧疆灏忕悆鍗婂緞
				setC(str);//閲嶆柊璁剧疆灏忕悆鑳屾櫙棰滆壊/鍥剧墖
				setBorderWidth(n);//閲嶆柊璁剧疆灏忕悆杈圭嚎瀹藉害
				setBorderColor(str);//閲嶆柊璁剧疆杈圭嚎棰滆壊
				setM(n);//閲嶈灏忕悆璐ㄩ噺,濡傛灉涓嶇粰鍙傛暟锛屽垯鎸夌収鍗婂緞閲嶆柊榛樿璐ㄩ噺
				setHTML(str);//閲嶈灏忕悆鍐呭
				setOpa(n);//閲嶈灏忕悆閫忔槑搴�

 
 */


function extend(a, b) {
	var a = a || {};
	for (var c in b) {
		if (typeof a[c] == 'undefined') a[c] = b[c]
	}
	return a
}
function CollBox(a, b) {
	var c = this.container = document.getElementById(a);
	var b = this.opts = b || {};
	this.width = b.width || c.offsetWidth;
	this.height = b.height || c.offsetHeight;
	this.child = []
}
CollBox.prototype.addBall = function(a) {
	this.child.push(a);
	if (a.opts.e.parentNode != this.container) {
		this.container.appendChild(a.opts.e)
	}
};
CollBox.prototype.ballRun = function() {
	clearInterval(this.ballRunTimer);
	var g = this;
	var w = this.width;
	var h = this.height;
	var k = this.isColl;
	var l = this.coll;
	this.ballRunTimer = setInterval(function() {
		var a = g.child;
		var c = a.length;
		for (var i = 0; i < c; i++) {
			a[i].foot()
		}
		for (var i = 0; i < c; i++) {
			var d = a[i].opts;
			var b = d.b;
			if (d.x < b) {
				d.x = b;
				d.sx *= -1
			}
			if (d.y < b) {
				d.y = b;
				d.sy *= -1
			}
			var e = w - b;
			if (d.x > e) {
				d.x = e;
				d.sx *= -1
			}
			var f = h - b;
			if (d.y > f) {
				d.y = f;
				d.sy *= -1
			}
		}
		for (var i = 0; i < c; i++) {
			for (var j = i + 1; j < c; j++) {
				if (k(a[i], a[j])) {
					l(a[i], a[j], function() {
						a[i].collNum++;
						a[i].opts.callBack.call(a[i], a[i].collNum);
						a[j].collNum++;
						a[j].opts.callBack.call(a[j], a[j].collNum)
					})
				}
			}
		}
	}, 30)
};
CollBox.prototype.ballStop = function() {
	clearInterval(this.ballRunTimer)
};
CollBox.prototype.coll = function(p, q, r) {
	var s = q.opts.x - p.opts.x;
	var t = q.opts.y - p.opts.y;
	var u = q.opts.sx - p.opts.sx;
	var v = q.opts.sy - p.opts.sy;
	var w = Math.atan2(v, u);
	var x = Math.atan2(-t, -s);
	var y = Math.abs(x - w);
	var D = Math.PI / 2;
	if (y <= 3 * D && y >= D) return;
	r && r();
	(function coll(a, b) {
		var c = Math.atan2(b.y - a.y, b.x - a.x);
		var D = Math.PI / 2;
		if (c > D * 2) c -= D * 2;
		var d = Math.cos(c);
		var e = Math.sin(c);
		var f = a.sx * d + a.sy * e;
		var g = a.sx * Math.cos(c + D) + a.sy * d;
		var h = b.sx * d + b.sy * e;
		var i = b.sx * Math.cos(c + D) + b.sy * d;
		var j = a.m,
			m2 = b.m;
		var k = j + m2;
		var l = ((j - m2) * f + 2 * m2 * h) / k;
		var m = ((m2 - j) * h + 2 * j * f) / k;
		var n = Math.cos(-c);
		var o = Math.sin(-c);
		a.sx = l * n + g * o;
		a.sy = l * Math.cos(D - c) + g * n;
		b.sx = m * n + i * o;
		b.sy = m * Math.cos(D - c) + i * n
	})(p.opts, q.opts)
};
CollBox.prototype.isColl = function(a, b) {
	if (a.stopfoot || b.stopfoot) return false;
	var d = Math.pow(a.opts.x - b.opts.x, 2) + Math.pow(a.opts.y - b.opts.y, 2);
	var c = Math.pow(a.opts.b + b.opts.b, 2);
	return d < c
};

function Obj(a) {
	if (a == 'extend') return;
	this.opts = extend(a || {}, {
		width: 60,
		height: 60,
		borderWidth: 0,
		borderColor: '#000',
		backGround: 'pink',
		fontSize: 12,
		opa: 1,
		x: 30,
		y: 30,
		sx: 3,
		sy: 3,
		m: 1,
		e: document.createElement('div'),
		callBack: function() {}
	});
	this.collNum = 0;
	this.initStyle();
	this.addEvent()
}
Obj.prototype.initStyle = function() {
	var a = this.opts.width;
	var b = this.opts.height;
	var c = this.opts.borderWidth;
	var s = this.opts.e.style;
	s.position = 'absolute';
	s.top = s.left = 0;
	s.width = a - c * 2 + 'px';
	var d = s.height = b - c * 2 + 'px';
	s.background = this.opts.c;
	s.backgroundSize = 'cover';
	s.border = c + 'px solid ' + this.opts.borderColor;
	s.opacity = this.opts.opa;
	if (this.opts.html) {
		this.opts.e.innerHTML = this.opts.html;
		s.textAlign = 'center';
		s.lineHeight = d;
		s.fontSize = this.opts.fontSize + 'px'
	}
	this.setPos()
};
Obj.prototype.addEvent = function() {
	var a = this;
	this.opts.e.onmouseenter = function() {
		a.stopFoot()
	};
	this.opts.e.onmouseout = function() {
		a.startFoot()
	}
};
Obj.prototype.foot = function(n) {
	if (this.stopfoot) return;
	var n = n || 1;
	this.opts.x += this.opts.sx * n;
	this.opts.y += this.opts.sy * n;
	this.setPos()
};
Obj.prototype.startFoot = function() {
	this.stopfoot = false;
	this.opts.e.style.zIndex = 1
};
Obj.prototype.stopFoot = function() {
	this.stopfoot = true;
	this.opts.e.style.zIndex = 999
};
Obj.prototype.setPos = function() {
	var a = this.opts.width / 2;
	var b = this.opts.height / 2;
	var x = parseInt(this.opts.x - a);
	var y = parseInt(this.opts.y - b);
	this.opts.e.style.transform = 'translate(' + x + 'px,' + y + 'px)';
	this.opts.e.style.webkitTransform = 'translate(' + x + 'px,' + y + 'px)'
};
Obj.prototype.setC = function(a) {
	var c = this.opts.c = a;
	this.opts.e.style.background = c;
	this.opts.e.style.backgroundSize = 'cover'
};
Obj.prototype.setBorderWidth = function(n) {
	var n = this.opts.borderWidth = n;
	var a = n * 2;
	var s = this.opts.e.style;
	s.width = parseInt(this.opts.width - a) + 'px';
	var b = s.height = parseInt(this.opts.height - a) + 'px';
	s.lineHeight = b;
	s.border = n + 'px solid ' + this.opts.borderColor
};
Obj.prototype.setBorderColor = function(a) {
	var a = this.opts.borderColor = a;
	this.opts.e.style.border = this.opts.borderWidth + 'px solid ' + a
};
Obj.prototype.setM = function(n) {
	this.opts.m = n || (this.opts.width * this.opts.height) / 3600
};
Obj.prototype.setHTML = function(a) {
	var b = this.opts.html = a;
	var s = this.opts.e.style;
	this.opts.e.innerHTML = b;
	s.textAlign = 'center';
	s.lineHeight = this.opts.height - this.opts.borderWidth * 2 + 'px';
	s.fontSize = this.opts.fontSize + 'px'
};
Obj.prototype.setOpa = function(n) {
	var a = this.opts.opa = n;
	this.opts.e.style.opacity = n
};

function Ball(a) {
	var a = this.opts = extend(a || {}, {
		type: 'ball',
		b: 30,
	});
	a.width = a.height = a.b * 2;
	Obj.call(this, a)
}
Ball.prototype = new Obj('extend');
Ball.prototype.constructor = Ball;
var initStyle = Ball.prototype.initStyle;
Ball.prototype.initStyle = function() {
	initStyle.call(this);
	this.opts.e.style.borderRadius = '50%'
}
Ball.prototype.setB = function(n) {
	var b = this.opts.b = n;
	var s = this.opts.e.style;
	this.opts.width = this.opts.height = b * 2;
	s.width = s.height = (b - this.opts.borderWidth) * 2 + 'px';
	s.lineHeight = (b - this.opts.borderWidth) * 2 + 'px';
	this.setPos()
};